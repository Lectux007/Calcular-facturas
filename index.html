<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1976d2">
  <meta name="background-color" content="#00332b">
  <link rel="icon" type="image/jpeg" sizes="192x192" href="Icono de calculadora_20250608_150126_0000.jpg">
  <link rel="apple-touch-icon" href="Icono de calculadora_20250608_150126_0000.jpg">
  <title>Control de Dinero</title>
  <style>
    :root {
      --primary: #40e0d0;
      --secondary: #1de9b6;
      --bg-dark: #00332b;
      --bg-light: #e0f7fa;
      --text-dark: #004d40;
      --text-light: #e0f7fa;
      --error: #ff4444;
    }
    /* Splash screen moderno y tecnolÃ³gico */
    #splash {
      position: fixed;
      z-index: 9999;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.8s;
      min-height: 100dvh;
      min-width: 100vw;
      overflow: hidden;
      background: transparent;
    }
    #splash:not(.splash-visible) {
      opacity: 0;
      pointer-events: none;
    }
    .splash-animated-bg {
      position: absolute;
      inset: 0;
      z-index: 0;
      background: linear-gradient(120deg, #0f2027 0%, #2c5364 60%, #8f94fb 100%);
      animation: splashGradientMove 6s linear infinite alternate;
      filter: blur(2px) brightness(0.85);
    }
    @keyframes splashGradientMove {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }
    .splash-animated-bg::after {
      content: "";
      display: block;
      position: absolute;
      inset: 0;
      pointer-events: none;
      background-image:
        repeating-linear-gradient(120deg, rgba(126,255,255,0.12) 0 1px, transparent 1px 20px),
        repeating-linear-gradient(60deg, rgba(255,0,255,0.08) 0 1px, transparent 1px 30px);
      opacity: 0.7;
      animation: splashLinesMove 12s linear infinite;
    }
    @keyframes splashLinesMove {
      0% { background-position: 0 0, 0 0; }
      100% { background-position: 80px 160px, 160px 80px; }
    }
    .splash-content {
      position: relative;
      z-index: 2;
      text-align: center;
      color: #fff;
      background: rgba(16, 18, 44, 0.75);
      padding: 40px 28px;
      border-radius: 22px;
      box-shadow:
        0 2px 24px #8f94fb88,
        0 0 24px #00ffe5cc,
        0 0 120px #a770ef55 inset;
      backdrop-filter: blur(8px);
      animation: splash-in 1.1s cubic-bezier(.56,.12,.37,1.2);
    }
    .splash-content h1 {
      font-size: 2.5em;
      margin-bottom: 0.5em;
      text-shadow: 0 0 24px #8f94fb, 0 0 12px #00ffe5, 0 0 2px #fff;
      letter-spacing: 1px;
      font-weight: 700;
    }
    .splash-content p {
      font-size: 1.15em;
      margin-bottom: 1.5em;
      letter-spacing: 0.5px;
      color: #c6f0ff;
    }
    .splash-content button {
      font-size: 1.15em;
      font-weight: bold;
      padding: 14px 48px;
      background: linear-gradient(90deg, #00ffe5 10%, #8f94fb 90%);
      color: #10122c;
      border: none;
      border-radius: 100px;
      box-shadow:
        0 0 18px #00ffe5cc,
        0 0 40px #8f94fb55 inset;
      cursor: pointer;
      transition: background 0.20s, color 0.20s, box-shadow 0.3s;
      position: relative;
      overflow: hidden;
    }
    .splash-content button::after {
      content: "";
      display: block;
      position: absolute;
      left: 10%;
      top: 0;
      width: 80%;
      height: 40%;
      background: linear-gradient(90deg, #fff8, #8f94fb44 70%, transparent 100%);
      opacity: 0.15;
      filter: blur(2px);
      pointer-events: none;
    }
    .splash-content button:hover {
      background: linear-gradient(90deg, #a770ef, #00ffe5 80%);
      color: #fff;
      box-shadow:
        0 0 32px #a770efcc,
        0 0 80px #00ffe5aa inset;
    }
    @keyframes splash-in {
      from { transform: scale(0.7) translateY(50px); opacity: 0;}
      to { transform: scale(1) translateY(0); opacity: 1;}
    }
    /** Fin splash **/

    body[data-theme="light"] {
      background: linear-gradient(135deg, #0fffc1, var(--bg-dark));
      color: var(--text-light);
    }
    body[data-theme="dark"] {
      background: linear-gradient(135deg, #232526, #00332b 90%);
      color: var(--text-light);
    }

    h1, h2, h3 {
      text-align: center;
      text-shadow: 0 0 5px var(--primary);
    }

    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab-btn {
      padding: 10px 20px;
      font-size: 16px;
      background: var(--primary);
      border: none;
      border-radius: 8px 8px 0 0;
      color: var(--text-dark);
      cursor: pointer;
      transition: background 0.3s, box-shadow 0.3s;
    }

    .tab-btn.active {
      background: var(--secondary);
      box-shadow: 0 0 15px var(--secondary);
    }

    .tab-btn:hover {
      background: var(--secondary);
    }

    .tab-content {
      display: none;
      background: var(--bg-dark);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px var(--primary) inset;
    }

    .tab-content.active {
      display: block;
    }

    .campo {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      text-shadow: 0 0 4px var(--primary);
    }

    input[type="number"], input[type="text"] {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background: var(--bg-dark);
      color: var(--text-light);
      box-shadow: 0 0 8px var(--primary) inset;
      transition: box-shadow 0.3s;
    }

    input[type="number"]:focus, input[type="text"]:focus {
      outline: none;
      box-shadow: 0 0 12px var(--primary) inset;
    }

    input.error {
      border: 2px solid var(--error);
    }

    .facturas-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .factura-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .factura-item input {
      flex: 1;
    }

    button {
      padding: 10px;
      margin-top: 10px;
      width: 100%;
      font-size: 16px;
      background: var(--primary);
      border: none;
      border-radius: 8px;
      color: var(--text-dark);
      cursor: pointer;
      box-shadow: 0 0 10px var(--primary);
      transition: background 0.3s, box-shadow 0.3s;
    }

    button:hover {
      background: var(--secondary);
      box-shadow: 0 0 15px var(--secondary);
    }

    .delete-btn {
      width: auto;
      padding: 5px 10px;
      font-size: 14px;
    }

    #error {
      text-align: center;
      font-weight: bold;
      font-size: 1.2em;
      margin-top: 10px;
      color: var(--error);
      text-shadow: 0 0 4px var(--error);
      display: none;
    }

    #resultado {
      text-align: center;
      font-weight: bold;
      font-size: 1.4em;
      margin-top: 15px;
      text-shadow: 0 0 6px var(--primary);
    }

    #historial {
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.9em;
      color: var(--text-light);
    }

    #historial div {
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }

    .config {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-bottom: 20px;
    }

    .stats {
      margin-top: 20px;
      padding: 10px;
      background: var(--bg-dark);
      border-radius: 8px;
      text-align: center;
    }
    /* AnimaciÃ³n de guardado y borrado */
    .feedback {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(90deg,#00ffe5,#8f94fb 80%);
      color: #10122c;
      font-weight: bold;
      padding: 12px 30px;
      border-radius: 100px;
      box-shadow: 0 0 18px #00ffe5cc;
      z-index: 9999;
      font-size: 1.1em;
      animation: feedbackfade 2.6s forwards;
      opacity: 0.98;
      pointer-events: none;
    }
    @keyframes feedbackfade {
      0% { opacity: 0; transform: translateX(-50%) scale(0.7);}
      10% { opacity: 1; transform: translateX(-50%) scale(1);}
      70% { opacity: 1;}
      100% { opacity: 0; transform: translateX(-50%) scale(0.7);}
    }
    /* Accesibilidad: focus visible */
    button:focus-visible, input:focus-visible {
      outline: 3px solid #a770ef;
      outline-offset: 2px;
    }
    /* Campo de error accesible */
    input.error:focus-visible {
      outline: 3px solid #ff4444;
    }
  </style>
</head>
<body>
  <!-- Splash de bienvenida moderno -->
  <div id="splash" class="splash-visible">
    <div class="splash-animated-bg"></div>
    <div class="splash-content">
      <h1>Â¡Bienvenido!</h1>
      <p>Controla tu dinero con tecnologÃ­a moderna</p>
      <button id="entrarApp">Entrar</button>
    </div>
  </div>
  <!-- Fin splash -->

  <!-- Feedback visual -->
  <div id="feedback" style="display:none"></div>

  <h1>Control de Dinero</h1>

  <div class="config">
    <button id="toggleSonido">ðŸ”Š Sonido: Activado</button>
    <button id="toggleTema">ðŸŒ™ Tema Oscuro</button>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="facturas">Facturas</button>
    <button class="tab-btn" data-tab="historial">Historial</button>
  </div>

  <div id="facturas-tab" class="tab-content active">
    <form id="facturaForm" autocomplete="off" onsubmit="return false;">
      <div class="campo">
        <label for="facturas">Facturas:</label>
        <div id="facturas" class="facturas-container"></div>
        <button type="button" id="btnAgregar">+ AÃ±adir factura</button>
      </div>
      <div class="campo">
        <label for="dineroRecibido">Dinero recibido:</label>
        <input id="dineroRecibido" type="number" step="0.01" min="0" aria-label="Dinero recibido" />
      </div>
      <div class="campo">
        <label for="rebaja">Rebaja (opcional):</label>
        <input id="rebaja" type="number" step="0.01" min="0" placeholder="Monto de rebaja" />
        <button type="button" id="btnAplicarRebaja">Aplicar Rebaja</button>
      </div>
      <button type="button" id="btnGuardar">Guardar en historial</button>
      <button type="button" id="btnLimpiar">Limpiar campos</button>
    </form>
    <div id="error" role="alert" aria-live="polite"></div>
    <h2 id="resultado"></h2>
  </div>

  <div id="historial-tab" class="tab-content">
    <h3>Historial:</h3>
    <div class="campo">
      <label for="filtroFecha">Filtrar por fecha:</label>
      <input id="filtroFecha" type="date" />
    </div>
    <div id="historial"></div>
    <div class="pagination">
      <button id="prevPage" disabled>Anterior</button>
      <span id="pageInfo"></span>
      <button id="nextPage">Siguiente</button>
    </div>
    <div class="stats" id="estadisticas"></div>
    <button id="btnBorrarHistorial">Borrar historial</button>
    <button id="btnDescargarHistorial">Descargar CSV</button>
    <button id="btnExportarPDF">Exportar PDF</button>
  </div>

  <!-- jsPDF + autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Splash screen behavior
      const splash = document.getElementById('splash');
      const entrarApp = document.getElementById('entrarApp');
      function ocultarSplash() {
        splash.classList.remove('splash-visible');
        setTimeout(() => { splash.style.display = 'none'; }, 800);
      }
      entrarApp.addEventListener('click', ocultarSplash);
      setTimeout(ocultarSplash, 6000); // 6 segundos

      const { jsPDF } = window.jspdf;
      const facturasContainer = document.getElementById('facturas');
      const dineroRecibido = document.getElementById('dineroRecibido');
      const rebajaInput = document.getElementById('rebaja');
      const resultado = document.getElementById('resultado');
      const errorDiv = document.getElementById('error');
      const historialDiv = document.getElementById('historial');
      const btnAgregar = document.getElementById('btnAgregar');
      const btnGuardar = document.getElementById('btnGuardar');
      const btnLimpiar = document.getElementById('btnLimpiar');
      const btnAplicarRebaja = document.getElementById('btnAplicarRebaja');
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');
      const toggleSonido = document.getElementById('toggleSonido');
      const toggleTema = document.getElementById('toggleTema');
      const filtroFecha = document.getElementById('filtroFecha');
      const prevPage = document.getElementById('prevPage');
      const nextPage = document.getElementById('nextPage');
      const pageInfo = document.getElementById('pageInfo');
      const estadisticas = document.getElementById('estadisticas');
      const facturaForm = document.getElementById('facturaForm');
      const feedbackDiv = document.getElementById('feedback');

      const textos = {
        sinTransacciones: 'No hay transacciones en el historial.',
        eliminar: 'Eliminar',
        guardar: 'Guardado en historial',
        borrado: 'Entrada eliminada',
        errorRebajaNegativa: 'La rebaja no puede ser negativa.',
        errorRebajaMayor: 'La rebaja no puede ser mayor al total de las facturas.',
        errorHistorial: 'No se pudo guardar el historial.',
        errorFacturas: 'AÃ±ade facturas vÃ¡lidas para guardar.',
        noEntradasExportar: 'No hay entradas para exportar.',
        errorPDF: 'No se pudo exportar PDF (autoTable no cargado)',
        historialBorrado: 'Historial borrado',
        camposLimpiados: 'Campos limpiados'
      };

      let sonidoHabilitado = true;
      let currentPage = 1;
      const itemsPerPage = 10;
      let historial = [];

      // -- BLOQUE DE GUARDADO Y RESTAURACIÃ“N DE FORMULARIO --
      const FORM_STATE_KEY = 'formularioTemporal';

      function guardarFormularioTemporal() {
        const facturas = Array.from(document.querySelectorAll('#facturas input')).map(x => x.value);
        const recibido = dineroRecibido.value;
        const rebaja = rebajaInput.value;
        localStorage.setItem(FORM_STATE_KEY, JSON.stringify({ facturas, recibido, rebaja }));
      }

      function restaurarFormularioTemporal() {
        const datos = localStorage.getItem(FORM_STATE_KEY);
        if (!datos) return;
        try {
          const { facturas, recibido, rebaja } = JSON.parse(datos);
          // Limpiar facturas existentes
          facturasContainer.innerHTML = '';
          // Restaurar cada factura
          if (facturas && facturas.length) {
            facturas.forEach(val => agregarFactura(val));
          } else {
            agregarFactura();
          }
          dineroRecibido.value = recibido || '';
          rebajaInput.value = rebaja || '';
          calcularAutomatico();
        } catch (e) {
          localStorage.removeItem(FORM_STATE_KEY);
          agregarFactura();
        }
      }
      // -- FIN BLOQUE GUARDADO Y RESTAURACIÃ“N --

      // Feedback visual animado
      function feedback(msg) {
        feedbackDiv.textContent = msg;
        feedbackDiv.style.display = 'block';
        feedbackDiv.className = 'feedback';
        setTimeout(() => {
          feedbackDiv.style.display = 'none';
        }, 2500);
      }

      function formatCurrency(value) {
        return Number(value).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function cargarTema() {
        const temaGuardado = localStorage.getItem('tema');
        if (temaGuardado === 'dark') {
          document.body.setAttribute('data-theme', 'dark');
          toggleTema.textContent = 'â˜€ï¸ Tema Claro';
        } else {
          document.body.setAttribute('data-theme', 'light');
          toggleTema.textContent = 'ðŸŒ™ Tema Oscuro';
        }
      }
      toggleTema.addEventListener('click', () => {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        localStorage.setItem('tema', isDark ? 'light' : 'dark');
        toggleTema.textContent = isDark ? 'ðŸŒ™ Tema Oscuro' : 'â˜€ï¸ Tema Claro';
        feedback(isDark ? 'Tema claro activado' : 'Tema oscuro activado');
      });

      // Sonido
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      let audioCtx = null;
      function initAudioContext() {
        if (!AudioContext) return false;
        if (!audioCtx) {
          try {
            audioCtx = new AudioContext();
          } catch (e) {
            return false;
          }
        }
        return true;
      }
      function playBeep() {
        if (!sonidoHabilitado || !initAudioContext()) return;
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.type = 'square';
        oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        setTimeout(() => oscillator.stop(), 100);
      }
      function playError() {
        if (!sonidoHabilitado || !initAudioContext()) return;
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(1200, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        setTimeout(() => oscillator.stop(), 200);
      }
      function playDestruction() {
        if (!sonidoHabilitado || !initAudioContext()) return;
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        const filter = audioCtx.createBiquadFilter();
        oscillator.type = 'sawtooth';
        oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(300, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        oscillator.connect(filter);
        filter.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        oscillator.frequency.exponentialRampToValueAtTime(20, audioCtx.currentTime + 0.3);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
        setTimeout(() => oscillator.stop(), 350);
      }

      function isLocalStorageAvailable() {
        try {
          const test = '__test__';
          localStorage.setItem(test, test);
          localStorage.removeItem(test);
          return true;
        } catch (e) {
          return false;
        }
      }

      function loadHistorial() {
        if (!isLocalStorageAvailable()) return [];
        try {
          const stored = localStorage.getItem('historial');
          return stored ? JSON.parse(stored).filter(validarEntrada) : [];
        } catch (e) {
          return [];
        }
      }

      function saveHistorial() {
        if (!isLocalStorageAvailable()) return;
        try {
          localStorage.setItem('historial', JSON.stringify(historial));
        } catch (e) {
          errorDiv.style.display = 'block';
          errorDiv.textContent = textos.errorHistorial;
        }
      }

      function validarEntrada(item) {
        return item && typeof item === 'object' &&
          ['fecha', 'totalFacturas', 'rebaja', 'total', 'recibido', 'devuelto']
            .every(key => key in item && item[key] !== undefined && item[key] !== null);
      }

      function switchTab(tabId) {
        tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
        tabContents.forEach(content => content.classList.toggle('active', content.id === `${tabId}-tab`));
        if (tabId === 'historial') mostrarHistorial();
        playBeep();
      }

      function renderFacturas() {
        if (facturasContainer.childElementCount === 0) agregarFactura();
      }

      function agregarFactura(valor = '') {
        const div = document.createElement('div');
        div.className = 'factura-item';
        const input = document.createElement('input');
        input.type = 'number';
        input.step = '0.01';
        input.min = '0';
        input.placeholder = 'Monto de factura';
        input.setAttribute('aria-label', 'Monto de factura');
        if (valor) input.value = valor;
        input.addEventListener('input', () => {
          const val = input.value.trim();
          if (!val || isNaN(val)) return;
          const numero = parseFloat(val);
          if (!isNaN(numero) && numero >= 0) {
            input.classList.remove('error');
          } else {
            input.classList.add('error');
          }
          calcularAutomatico();
          guardarFormularioTemporal();
        });
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.type = 'button';
        deleteBtn.textContent = textos.eliminar;
        deleteBtn.setAttribute('aria-label', 'Eliminar factura');
        deleteBtn.addEventListener('click', () => {
          div.remove();
          calcularAutomatico();
          guardarFormularioTemporal();
          playDestruction();
          feedback(textos.borrado);
        });
        div.appendChild(input);
        div.appendChild(deleteBtn);
        facturasContainer.appendChild(div);
        input.focus();
        playBeep();
      }

      function obtenerSumaFacturas() {
        let suma = 0;
        document.querySelectorAll('#facturas input').forEach(input => {
          const val = parseFloat(input.value);
          if (isNaN(val) || val <= 0) {
            input.classList.add('error');
          } else {
            input.classList.remove('error');
            suma += val;
          }
        });

        const rebaja = parseFloat(rebajaInput.value) || 0;
        if (rebaja < 0) {
          rebajaInput.classList.add('error');
          errorDiv.style.display = 'block';
          errorDiv.textContent = textos.errorRebajaNegativa;
          playError();
          return null;
        }

        if (rebaja > suma) {
          rebajaInput.classList.add('error');
          errorDiv.style.display = 'block';
          errorDiv.textContent = textos.errorRebajaMayor;
          playError();
          return null;
        }

        errorDiv.style.display = 'none';
        return { totalFacturas: suma, rebaja };
      }

      function calcularAutomatico() {
        errorDiv.style.display = 'none';
        const suma = obtenerSumaFacturas();
        if (suma === null) {
          resultado.innerHTML = '';
          return;
        }
        const { totalFacturas, rebaja } = suma;
        const totalAjustado = totalFacturas - rebaja;
        const recibido = parseFloat(dineroRecibido.value) || 0;
        const devuelto = recibido - totalAjustado;
        resultado.innerHTML = `
          Total Facturas: ${formatCurrency(totalFacturas)}<br>
          Rebaja: ${formatCurrency(rebaja)}<br>
          Total Ajustado: ${formatCurrency(totalAjustado)}<br>
          Dinero devuelto: ${formatCurrency(devuelto)}
        `;
      }

      // Guardar en localStorage al cambiar campos
      dineroRecibido.addEventListener('input', () => {
        calcularAutomatico();
        guardarFormularioTemporal();
      });
      rebajaInput.addEventListener('input', () => {
        calcularAutomatico();
        guardarFormularioTemporal();
      });
      facturasContainer.addEventListener('input', guardarFormularioTemporal);

      function guardarHistorial() {
        const suma = obtenerSumaFacturas();
        if (suma === null || suma.totalFacturas === 0) {
          errorDiv.style.display = 'block';
          errorDiv.textContent = textos.errorFacturas;
          playError();
          return;
        }
        const { totalFacturas, rebaja } = suma;
        const totalAjustado = totalFacturas - rebaja;
        const recibido = parseFloat(dineroRecibido.value) || 0;
        const devuelto = recibido - totalAjustado;
        const fecha = new Date().toLocaleString();
        historial.unshift({
          fecha,
          transaccionNum: historial.filter(i => i.fecha.split(',')[0] === fecha.split(',')[0]).length + 1,
          totalFacturas,
          rebaja,
          total: totalAjustado,
          recibido,
          devuelto
        });
        saveHistorial();
        limpiarCampos();
        localStorage.removeItem(FORM_STATE_KEY); // limpiar temporal
        switchTab('historial');
        mostrarHistorial();
        playBeep();
        feedback(textos.guardar);
      }

      function limpiarCampos() {
        facturasContainer.innerHTML = '';
        dineroRecibido.value = '';
        rebajaInput.value = '';
        resultado.innerHTML = '';
        errorDiv.style.display = 'none';
        agregarFactura();
        localStorage.removeItem(FORM_STATE_KEY); // limpiar temporal
        playBeep();
        feedback(textos.camposLimpiados);
      }

      function mostrarHistorial(page = 1) {
        historial = loadHistorial();
        const filteredHistorial = filtroFecha.value
          ? historial.filter(item => item.fecha.startsWith(filtroFecha.value))
          : historial;

        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedHistorial = filteredHistorial.slice(start, end);

        historialDiv.innerHTML = paginatedHistorial.map((item, index) => `
          <div>
            <span>TransacciÃ³n ${item.transaccionNum} - <strong>${item.fecha}</strong>:
              Total: ${formatCurrency(item.total)}</span>
            <button class="delete-btn" type="button" onclick="eliminarEntrada(${start + index})">${textos.eliminar}</button>
          </div>
        `).join('');

        if (paginatedHistorial.length === 0) {
          historialDiv.innerHTML = `<p>${textos.sinTransacciones}</p>`;
        }

        currentPage = page;
        pageInfo.textContent = `PÃ¡gina ${page} de ${Math.max(1, Math.ceil(filteredHistorial.length / itemsPerPage))}`;
        prevPage.disabled = page === 1;
        nextPage.disabled = end >= filteredHistorial.length;

        actualizarEstadisticas(filteredHistorial);
      }

      function actualizarEstadisticas(historialFiltrado) {
        if (!historialFiltrado || historialFiltrado.length === 0) {
          estadisticas.textContent = '';
          return;
        }
        const sumaTotal = historialFiltrado.reduce((acc, item) => acc + item.total, 0);
        const sumaRecibido = historialFiltrado.reduce((acc, item) => acc + item.recibido, 0);
        const sumaDevuelto = historialFiltrado.reduce((acc, item) => acc + item.devuelto, 0);
        estadisticas.innerHTML = `
          <strong>EstadÃ­sticas del filtro:</strong><br>
          Suma total: ${formatCurrency(sumaTotal)}<br>
          Suma recibido: ${formatCurrency(sumaRecibido)}<br>
          Suma devuelto: ${formatCurrency(sumaDevuelto)}<br>
          Transacciones: ${historialFiltrado.length}
        `;
      }

      function eliminarEntrada(index) {
        historial.splice(index, 1);
        saveHistorial();
        const totalPages = Math.max(1, Math.ceil(historial.length / itemsPerPage));
        if (currentPage > totalPages) currentPage = totalPages;
        mostrarHistorial(currentPage);
        playDestruction();
        feedback(textos.borrado);
      }
      window.eliminarEntrada = eliminarEntrada;

      function descargarHistorial() {
        historial = loadHistorial();
        let csv = 'Fecha,Total Facturas,Rebaja,Total,Recibido,Devuelto\n';
        historial.forEach(item => {
          csv += `${item.fecha},${item.totalFacturas},${item.rebaja},${item.total},${item.recibido},${item.devuelto}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `historial_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        playBeep();
        feedback('Historial descargado');
      }

      function exportarHistorialPDF() {
        historial = loadHistorial();
        if (historial.length === 0) {
          errorDiv.style.display = 'block';
          errorDiv.textContent = textos.noEntradasExportar;
          playError();
          return;
        }
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text('Historial de Transacciones', 20, 20);
        const headers = [['Fecha', 'Total Facturas', 'Rebaja', 'Total', 'Recibido', 'Devuelto']];
        const data = historial.map(item => [
          item.fecha,
          item.totalFacturas.toFixed(2),
          item.rebaja.toFixed(2),
          item.total.toFixed(2),
          item.recibido.toFixed(2),
          item.devuelto.toFixed(2)
        ]);
        if (typeof doc.autoTable === 'function') {
          doc.autoTable({ head: headers, body: data, startY: 30 });
          doc.save(`historial_transacciones_${new Date().toISOString().split('T')[0]}.pdf`);
          playBeep();
          feedback('Historial PDF generado');
        } else {
          errorDiv.style.display = 'block';
          errorDiv.textContent = textos.errorPDF;
          playError();
        }
      }

      function borrarHistorial() {
        if (confirm('Â¿Seguro que quieres borrar todo el historial?')) {
          historial = [];
          saveHistorial();
          mostrarHistorial();
          playDestruction();
          feedback(textos.historialBorrado);
        }
      }

      toggleSonido.addEventListener('click', () => {
        sonidoHabilitado = !sonidoHabilitado;
        toggleSonido.textContent = `ðŸ”Š Sonido: ${sonidoHabilitado ? 'Activado' : 'Desactivado'}`;
        playBeep();
        feedback(`Sonido ${sonidoHabilitado ? 'activado' : 'desactivado'}`);
      });

      filtroFecha.addEventListener('input', () => {
        currentPage = 1;
        mostrarHistorial();
      });

      prevPage.addEventListener('click', () => {
        if (currentPage > 1) mostrarHistorial(currentPage - 1);
      });

      nextPage.addEventListener('click', () => {
        mostrarHistorial(currentPage + 1);
      });

      tabButtons.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));

      btnAgregar.addEventListener('click', () => {
        agregarFactura();
        guardarFormularioTemporal();
      });

      btnGuardar.addEventListener('click', guardarHistorial);
      btnLimpiar.addEventListener('click', limpiarCampos);
      btnAplicarRebaja.addEventListener('click', calcularAutomatico);
      document.getElementById('btnBorrarHistorial').addEventListener('click', borrarHistorial);
      document.getElementById('btnDescargarHistorial').addEventListener('click', descargarHistorial);
      document.getElementById('btnExportarPDF').addEventListener('click', exportarHistorialPDF);

      facturaForm.addEventListener('submit', (e) => {
        e.preventDefault();
        guardarHistorial();
      });

      cargarTema();
      renderFacturas();
      restaurarFormularioTemporal();
      mostrarHistorial();
      switchTab('facturas');
      // === BANNER DE ACTUALIZACIÃ“N ===
if ('serviceWorker' in navigator) {
  let newWorker;
  navigator.serviceWorker.register('sw.js').then(registration => {
    registration.onupdatefound = () => {
      newWorker = registration.installing;
      newWorker.onstatechange = () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          const updateBanner = document.createElement('div');
          updateBanner.style = 'position:fixed;bottom:0;left:0;right:0;background:#1976d2;color:#fff;text-align:center;padding:12px;z-index:9999;';
          updateBanner.innerHTML = `Â¡Nueva versiÃ³n disponible! <button id="reloadBtn" style="margin-left:14px;">Actualizar</button>`;
          document.body.appendChild(updateBanner);
          document.getElementById('reloadBtn').onclick = () => {
            newWorker.postMessage({ type: 'SKIP_WAITING' });
            window.location.reload();
          };
        }
      };
    };
  });

  let refreshing;
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (refreshing) return;
    window.location.reload();
    refreshing = true;
  });
}

// === BANNER DE INSTALACIÃ“N PWA ===
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const installBanner = document.createElement('div');
  installBanner.style = 'position:fixed;bottom:0;left:0;right:0;background:#00332b;color:#fff;text-align:center;padding:12px;z-index:9999;';
  installBanner.innerHTML = `Â¿Quieres instalar esta app? <button id="btnInstall" style="margin-left:14px;">Instalar</button>`;
  document.body.appendChild(installBanner);
  document.getElementById('btnInstall').onclick = () => {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(() => {
      installBanner.remove();
    });
  };
});
    });
  </script>

</body>
</html>